{
  "hash": "073f39108d88fcee84422b6a0a5e2e11",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Match Figures\nauthor: John Curtin\neditor_options: \n  chunk_output_type: console\n---\n\n\n## Set up environment\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\noptions(conflicts.policy = \"depends.ok\")\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ntheme_set(theme_classic()) \n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"a58e57da996d1b70bb9a5b58241325d6fd78890f\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\npath_models <- format_path(\"studydata/match/models/pp_hybrid_wk4_outcome\")\n```\n:::\n\n\n\n## Load and format data\n\nLoad raw data for outcomes\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nversion <- \"v5\"\nd <- read_csv(here::here(path_models, str_c(\"aim_2_\", version, \".csv\")),\n              show_col_types = FALSE) |> \n  mutate(outcome_rct_wk4_num = if_else(outcome_rct_wk4 == \"abstinent\", 1, 0),\n         outcome_rct_wk12_num = if_else(outcome_rct_wk12 == \"abstinent\", 1, 0),\n         outcome_rct_wk26_num = if_else(outcome_rct_wk26 == \"abstinent\", 1, 0),\n         tx_worst = case_when(\n           prob_patch < prob_combo_nrt & prob_patch < prob_varenicline ~ \"patch\",\n           prob_combo_nrt < prob_patch & prob_combo_nrt < prob_varenicline ~ \"combo_nrt\",\n           prob_varenicline < prob_patch & prob_varenicline < prob_combo_nrt ~ \"varenicline\",\n           TRUE ~ NA_character_),\n         tx_second = case_when(\n           tx_worst == \"patch\" & tx_best == \"varenicline\" ~ \"combo_nrt\",\n           tx_worst == \"patch\" & tx_best == \"combo_nrt\" ~ \"varenicline\",\n           tx_worst == \"varenicline\" & tx_best == \"patch\" ~ \"combo_nrt\",\n           tx_worst == \"varenicline\" & tx_best == \"combo_nrt\" ~ \"patch\",\n           tx_worst == \"combo_nrt\" & tx_best == \"varenicline\" ~ \"patch\",\n           tx_worst == \"combo_nrt\" & tx_best == \"patch\" ~ \"varenicline\",\n           TRUE ~ NA_character_)) |> \n  mutate(tx_rank = case_when(\n    tx_rct == tx_best ~ \"optimal\",\n    tx_rct == tx_second ~ \"intermediate\",\n    tx_rct == tx_worst ~ \"worst\",\n    TRUE ~ NA_character_)) |> \n  select(subid, starts_with(\"tx_\"), starts_with(\"prob_\"),\n         outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num) |> \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,086\nColumns: 14\n$ subid                <dbl> 20010, 20015, 20030, 20049, 20051, 20072, 20077, …\n$ tx_rct               <chr> \"patch\", \"combo_nrt\", \"patch\", \"varenicline\", \"pa…\n$ tx_best              <chr> \"varenicline\", \"varenicline\", \"combo_nrt\", \"varen…\n$ tx_match             <lgl> FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, F…\n$ tx_worst             <chr> \"combo_nrt\", \"patch\", \"patch\", \"patch\", \"patch\", …\n$ tx_second            <chr> \"patch\", \"combo_nrt\", \"varenicline\", \"combo_nrt\",…\n$ tx_rank              <chr> \"intermediate\", \"intermediate\", \"worst\", \"optimal…\n$ prob_best            <dbl> 0.2646638, 0.4846121, 0.3136065, 0.4322435, 0.432…\n$ prob_patch           <dbl> 0.2007715, 0.4175508, 0.2309921, 0.3847692, 0.313…\n$ prob_combo_nrt       <dbl> 0.1845281, 0.4643572, 0.3136065, 0.3954174, 0.432…\n$ prob_varenicline     <dbl> 0.2646638, 0.4846121, 0.2747510, 0.4322435, 0.422…\n$ outcome_rct_wk4_num  <dbl> 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0…\n$ outcome_rct_wk12_num <dbl> 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0…\n$ outcome_rct_wk26_num <dbl> 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0…\n```\n\n\n:::\n:::\n\n\n\nMake df for outcomes by predicted tx rank and wave\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_rank <- d |> \n  select(subid, tx_rank, \n         outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num) |> \n  pivot_longer(\n    cols = c(outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num),\n    names_to = \"week\",\n    names_pattern = \"(?<=outcome_rct_)(.+)(?=_num)\",\n    values_to = \"outcome\") |> \n  summarize(outcome = mean(outcome), .by = c(tx_rank, week)) |> \n  rename (tx = tx_rank)\n```\n:::\n\n\nmake df for outcomes by rct assigned tx and week\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_tx <- d |> \n  select(subid, tx_rct, starts_with(\"outcome\")) |> \n  pivot_longer(cols = c(outcome_rct_wk4_num, outcome_rct_wk12_num, outcome_rct_wk26_num),\n               names_to = \"week\",\n               names_pattern = \"(?<=outcome_rct_)(.+)(?=_num)\",\n               values_to = \"outcome\") |> \n  group_by(tx_rct, week) |> \n    summarize(outcome = mean(outcome), .groups = \"drop\")\n```\n:::\n\n\nmake df for outcomes by week collapsed across rct assigned tx (unweighted)\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nd_week <- d |> \n  select(subid, tx_rct, starts_with(\"outcome\")) |> \n  pivot_longer(cols = c(outcome_rct_wk4_num, outcome_rct_wk12_num, \n                        outcome_rct_wk26_num),\n               names_to = \"week\",\n               names_pattern = \"(?<=outcome_rct_)(.+)(?=_num)\",\n               values_to = \"outcome\") |> \n  group_by(tx_rct, week) |> \n  summarize(outcome = mean(outcome), .groups = \"drop\") |> \n  group_by(week) |> \n  summarize(outcome = mean(outcome), .groups = \"drop\") |> \n  mutate(tx = \"rct\") |> \n  relocate(tx)\n```\n:::\n\n\n## Plot function\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nplot_outcomes <- function(d) {\n  \n  d |> \n    mutate(tx = fct(tx, levels = c(\"rct\", \"optimal\", \"intermediate\", \"worst\")),\n           week = fct(week, levels = c(\"wk4\", \"wk12\", \"wk26\"))) |> \n    ggplot(aes(x = week, y = outcome, fill = tx)) +\n      geom_col(position = \"dodge\") +\n      scale_fill_manual(\"Tx Received\", \n                      values = c(\"rct\" = \"gray\", \"optimal\" = \"green\", \n                                 \"intermediate\" = \"blue\", \"worst\" = \"red\")) +\n    ylab(\"Abstinence (point prevalance)\") +\n    ylim(0, .47)\n}\n```\n:::\n\n\n### AIM 2\n\n\nA series of plots to unpack the result\n\n::: {#cell-fig-tx_week_1 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-tx_week_1\n#| fig-cap: \"Abstince Rate over Time by Tx Received\"\n#| fig-height: 6\n#| fig-width: 6\n\nd_rank |>\n  bind_rows(d_week) |>\n  mutate(outcome = if_else(tx == \"rct\" & week == \"wk4\", outcome, 0)) |>\n  plot_outcomes()\n```\n\n::: {.cell-output-display}\n![Abstince Rate over Time by Tx Received](match_figs_files/figure-html/fig-tx_week_1-1.png){#fig-tx_week_1 width=576}\n:::\n:::\n\n::: {#cell-fig-tx_week_2 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-tx_week_2\n#| fig-cap: \"Abstince Rate over Time by Tx Received\"\n#| fig-height: 6\n#| fig-width: 6\n\nd_rank |> \n  bind_rows(d_week) |> \n  mutate(outcome = if_else((tx == \"rct\" | tx == \"optimal\") &\n                            week == \"wk4\", outcome, 0)) |> \n  plot_outcomes()\n```\n\n::: {.cell-output-display}\n![Abstince Rate over Time by Tx Received](match_figs_files/figure-html/fig-tx_week_2-1.png){#fig-tx_week_2 width=576}\n:::\n:::\n\n::: {#cell-fig-tx_week_3 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-tx_week_3\n#| fig-cap: \"Abstince Rate over Time by Tx Received\"\n#| fig-height: 6\n#| fig-width: 6\n\nd_rank |> \n  bind_rows(d_week) |> \n  mutate(outcome = if_else(tx == \"rct\" | tx == \"optimal\", outcome, 0)) |> \n  plot_outcomes()\n```\n\n::: {.cell-output-display}\n![Abstince Rate over Time by Tx Received](match_figs_files/figure-html/fig-tx_week_3-1.png){#fig-tx_week_3 width=576}\n:::\n:::\n\n::: {#cell-fig-tx_week_4 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-tx_week_4\n#| fig-cap: \"Abstince Rate over Time by Tx Received\"\n#| fig-height: 6\n#| fig-width: 6\n\nd_rank |> \n  bind_rows(d_week) |> \n  mutate(outcome = if_else(tx == \"rct\" | tx == \"optimal\" |\n                           week == \"wk4\", outcome, 0)) |> \n  plot_outcomes()\n```\n\n::: {.cell-output-display}\n![Abstince Rate over Time by Tx Received](match_figs_files/figure-html/fig-tx_week_4-1.png){#fig-tx_week_4 width=576}\n:::\n:::\n\n::: {#cell-fig-tx_week_5 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-tx_week_5\n#| fig-cap: \"Abstince Rate over Time by Tx Received\"\n#| fig-height: 6\n#| fig-width: 6\n\nd_rank |> \n  bind_rows(d_week) |> \n  plot_outcomes()\n```\n\n::: {.cell-output-display}\n![Abstince Rate over Time by Tx Received](match_figs_files/figure-html/fig-tx_week_5-1.png){#fig-tx_week_5 width=576}\n:::\n:::",
    "supporting": [
      "match_figs_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}